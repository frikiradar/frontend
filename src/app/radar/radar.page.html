<ion-header class="ion-no-border">
  <ion-toolbar>
    <ion-title mode="md">
      <ion-icon src="/assets/icon/icon.svg"></ion-icon>
      <ion-label>frikiradar</ion-label>
    </ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="changeView()" *ngIf="users">
        <ion-icon
          slot="icon-only"
          [name]="view === 'cards' ? 'list' : 'albums'"
        ></ion-icon>
      </ion-button>
      <ion-button id="filter-options">
        <ion-icon slot="icon-only" name="filter"></ion-icon>
      </ion-button>
      <ion-button (click)="notifications()">
        <ion-icon slot="icon-only" name="notifications-outline"></ion-icon>
        <ion-badge slot="end" color="primary" *ngIf="counters?.notifications"
          >{{ counters.notifications }}</ion-badge
        >
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>
<ion-content #radarlist [scrollEvents]="true" (ionScroll)="onScroll($event)">
  <ion-progress-bar type="indeterminate" *ngIf="loading"></ion-progress-bar>
  <div *ngIf="view === 'cards'" style="height: 100%">
    <swiper
      id="radar-slide"
      #slides
      (slideNextTransitionEnd)="slide()"
      (swiper)="setSwiperInstance($event)"
      [config]="slideOpts"
    >
      <ng-template swiperSlide *ngFor="let user of users;">
        <ion-card
          class="no-scroll"
          button
          *ngIf="user?.username; else adContainer"
        >
          <swiper
            class="images-slide"
            [config]="slideImagesOpts"
            (tap)="tap($event, user)"
          >
            <ng-template swiperSlide>
              <div class="background-image">
                <img
                  [src]="user?.avatar"
                  [alt]="users?.username"
                  default="/assets/img/users/default.png"
                />
              </div>
            </ng-template>
            <ng-template swiperSlide *ngFor="let image of user.images">
              <div class="background-image">
                <img
                  [src]="image"
                  [alt]="users?.username"
                  default="/assets/img/users/default.png"
                />
              </div>
            </ng-template>
          </swiper>
          <div class="info" button (click)="showProfile(user.id)">
            <ion-card-header>
              <div class="match full-center">{{ user.match }}%</div>
              <ion-card-title>
                <ion-badge
                  *ngIf="(user?.last_login | niceDate) === 'Ahora mismo'"
                  color="secondary"
                  >&nbsp;</ion-badge
                >
                <ion-text class="name">{{ user.name }}</ion-text>
                <ion-text class="age">, {{ user.age }}</ion-text>
              </ion-card-title>
            </ion-card-header>
            <ion-card-content>
              <ion-item
                class="info-distance ion-no-padding"
                *ngIf="user.distance !==
                undefined"
                lines="none"
              >
                <ion-icon
                  name="location-sharp"
                  slot="start"
                  color="secondary"
                  class="ion-margin-end"
                ></ion-icon>
                <ion-label>
                  <ion-text>A {{ user.distance }}km de distancia</ion-text>
                </ion-label>
              </ion-item>
              <ion-text class="description">{{user.description}}</ion-text>
              <div class="tags" *ngIf="user?.common_tags?.length">
                <ion-chip
                  *ngFor="let tag of user.common_tags"
                  color="secondary"
                >
                  <ion-label>{{ tag }}</ion-label>
                </ion-chip>
              </div>
            </ion-card-content>
            <ion-item lines="none" class="more" button>
              <ion-icon name="chevron-down-outline"></ion-icon>
            </ion-item>
          </div>
        </ion-card>
        <ng-template #adContainer>
          <app-ad [ad]="user"></app-ad>
        </ng-template>
      </ng-template>
      <ng-template swiperSlide *ngIf="!loading">
        <div class="full-center ion-padding">
          <ion-icon name="location"></ion-icon>
          <h2>Sin resultados</h2>
          <p>
            Modifica tus ajustes de "Estoy buscando..." en tu configuración de
            perfil y añade más "Gustos frikis" para mejorar los resultados.
          </p>
          <ion-button shape="round" (click)="editProfile()"
            >Editar mi perfil</ion-button
          >
          <br />
          <p>
            También puedes probar suerte cambiando a la vista por kilómetros
          </p>
          <ion-button shape="round" (click)="changeView()"
            ><ion-icon name="list" slot="start" size="small"></ion-icon>Cambiar
            a vista por kilómetros</ion-button
          >
        </div>
      </ng-template>
    </swiper>
  </div>
  <div *ngIf="view === 'list'" style="height: 100%">
    <!--<p class="ion-padding">
        Estos son los resultados obtenidos
        <span *ngIf="ratio <= 1000"> un radio de {{ ratio }}km</span><span *ngIf="ratio > 1000">mundialmente</span> con un
        porcentaje de
        coincidencia más alto.
      </p>-->
    <ion-list *ngIf="!users.length">
      <ion-item *ngFor="let i of [].constructor(8)" lines="none">
        <ion-avatar slot="start">
          <ion-skeleton-text animated></ion-skeleton-text>
        </ion-avatar>
        <ion-label>
          <h2>
            <ion-skeleton-text animated style="width: 50%"></ion-skeleton-text>
          </h2>
          <h3>
            <ion-skeleton-text animated style="width: 80%"></ion-skeleton-text>
          </h3>
          <p>
            <ion-skeleton-text animated style="width: 60%"></ion-skeleton-text>
          </p>
        </ion-label>
      </ion-item>
    </ion-list>
    <ion-list *ngIf="users?.length > 0">
      <ion-item-sliding
        *ngFor="let user of users; "
        (ionDrag)="dragItem($event, user.id)"
      >
        <ion-item-options side="start">
          <ion-item-option (click)="showProfile(user.id)">
            <ion-icon slot="icon-only" name="heart"></ion-icon>
          </ion-item-option>
        </ion-item-options>
        <ion-item button (click)="showProfile(user.id)">
          <ion-avatar slot="start">
            <img
              [src]="user?.thumbnail"
              default="/assets/img/users/default.png"
            />
            <ion-badge
              *ngIf="(user?.last_login | niceDate) === 'Ahora mismo'"
              color="secondary"
              >&nbsp;</ion-badge
            >
          </ion-avatar>
          <ion-label>
            <h2>
              <span class="name">{{ user.name }}</span>
              <span class="age">, {{ user.age }}</span>
            </h2>
            <p class="description">{{ user.description }}</p>
          </ion-label>
          <div class="match-list full-center" slot="end">{{ user.match }}%</div>
        </ion-item>
        <ion-item-options side="end">
          <ion-item-option
            color="danger"
            (click)="hideProfile(user.id)"
            expandable
          >
            <ion-icon slot="icon-only" name="close-circle"></ion-icon>
          </ion-item-option>
        </ion-item-options>
      </ion-item-sliding>
      <ion-infinite-scroll
        threshold="50%"
        (ionInfinite)="getRadarUsers($event)"
        position="bottom"
      >
        <ion-infinite-scroll-content loadingSpinner="dots">
        </ion-infinite-scroll-content>
      </ion-infinite-scroll>
    </ion-list>
    <div
      class="full-center ion-padding"
      *ngIf="users?.length === 0 && (!automatic || ratio === 25000)"
    >
      <ion-icon name="location"></ion-icon>
      <h2>Sin resultados</h2>
      <p>
        Modifica tus ajustes de "Estoy buscando..." en tu configuración de
        perfil y añade tus "Gustos frikis" para mejorar los resultados.
      </p>
      <ion-button shape="round" (click)="editProfile()"
        >Editar perfil</ion-button
      >
    </div>
  </div>
</ion-content>
<ion-footer
  id="radar-range"
  *ngIf="view === 'list'"
  [class.hide-background]="hide || loading"
>
  <ion-range
    mode="ios"
    #range
    min="0"
    max="4"
    step="1"
    [snaps]="true"
    [ticks]="true"
    [debounce]="250"
    [value]="rangeValue"
    (ionChange)="changeRatio($event.detail.value)"
    (click)="automatic = false"
  >
    <ion-icon slot="start" name="radio"></ion-icon>
    <ion-icon slot="end" name="globe"></ion-icon>
  </ion-range>
  <ion-grid id="range-distance">
    <ion-row>
      <ion-col></ion-col>
      <ion-col>100km</ion-col>
      <ion-col>500km</ion-col>
      <ion-col>1000km</ion-col>
      <ion-col></ion-col>
    </ion-row>
  </ion-grid>
</ion-footer>

<!-- modals -->

<ion-modal
  [initialBreakpoint]="0.5"
  [breakpoints]="[0, 0.5]"
  trigger="filter-options"
  cssClass="sheet-modal"
  (didDismiss)="dismissFilterOptions()"
>
  <ng-template>
    <ion-content class="ion-padding">
      <ion-item lines="full">
        <ion-label class="ion-text-center">Filtros de radar</ion-label>
      </ion-item>
      <ion-list>
        <ion-item lines="none">
          <ion-toggle
            [ngModel]="extended"
            (ngModelChange)="radarSearchChange($event)"
          >
            <p *ngIf="extended">Búsqueda ampliada</p>
            <p *ngIf="!extended">Búsqueda estricta</p>
          </ion-toggle>
        </ion-item>
        <ion-item>
          <ion-label class="ion-text-wrap" *ngIf="!extended">
            <p>
              Se tiene en cuenta tu configuración del perfil en la búsqueda
              (identidad de género, rango de edad y tipo de conexión).
            </p>
          </ion-label>
          <ion-label class="ion-text-wrap" *ngIf="extended">
            <p>
              No se tiene en cuenta tu configuración del perfil en la búsqueda.
              Se obtienen todos los resultados posibles.
            </p>
          </ion-label>
        </ion-item>
        <ion-item-group *ngIf="extended">
          <ion-item lines="none" *ngIf="auth.currentUserValue?.lovegender">
            <ion-toggle
              [ngModel]="searchOptions?.identity"
              (ngModelChange)="radarSearchOptions('identity', $event)"
            >
              <h2>Identidad de género</h2>
              <p>{{auth.currentUserValue?.lovegender}}</p>
            </ion-toggle>
          </ion-item>
          <ion-item
            lines="none"
            *ngIf="auth.currentUserValue?.minage && auth.currentUserValue?.maxage"
          >
            <ion-toggle
              [ngModel]="searchOptions?.range"
              (ngModelChange)="radarSearchOptions('range', $event)"
            >
              <h2>Rango de edad</h2>
              <p>
                {{auth.currentUserValue?.minage}} -
                {{auth.currentUserValue?.maxage}}
              </p>
            </ion-toggle>
          </ion-item>
          <ion-item
            lines="none"
            *ngIf="auth.currentUserValue?.connection?.length"
          >
            <ion-toggle
              [ngModel]="searchOptions?.connection"
              (ngModelChange)="radarSearchOptions('connection', $event)"
              aria-label="Tipo de conexión"
            >
              <h2>Tipo de conexión</h2>
              <p>{{auth.currentUserValue?.connection}}</p>
            </ion-toggle>
          </ion-item>
        </ion-item-group>
      </ion-list>
    </ion-content>
  </ng-template>
</ion-modal>

<ion-backdrop visible="true" *ngIf="showBackdrop"></ion-backdrop>
