<ion-header class="ion-no-border">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-button class="back" (click)="back()">
        <ion-icon slot="icon-only" name="arrow-back"></ion-icon>
      </ion-button>
    </ion-buttons>
    <ion-buttons slot="end" *ngIf="auth.currentUserValue">
      <ion-button
        id="edit-profile"
        (click)="editProfile()"
        *ngIf="user?.id === auth.currentUserValue?.id"
        shape="round"
      >
        <ion-icon name="create-outline"></ion-icon>
        <ion-label>Editar perfil</ion-label>
      </ion-button>
      <ion-button
        (click)="showOptions($event)"
        *ngIf="user?.active && user?.id !== 1"
      >
        <ion-icon slot="icon-only" name="ellipsis-vertical"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content>
  <div *ngIf="user || loading; else noUser">
    <ion-list *ngIf="loading; else profile">
      <ion-item lines="none">
        <ion-label>
          <h1>
            <ion-skeleton-text animated style="width: 75%"></ion-skeleton-text>
          </h1>
          <h3>
            <ion-skeleton-text animated style="width: 50%"></ion-skeleton-text>
          </h3>
        </ion-label>
      </ion-item>
      <ion-item lines="none">
        <ion-label>
          <span *ngFor="let i of [].constructor(20)">
            <p>
              <ion-skeleton-text
                animated
                style="width: 100%"
              ></ion-skeleton-text>
            </p>
            <p>
              <ion-skeleton-text
                animated
                style="width: 95%"
              ></ion-skeleton-text>
            </p>
          </span>
        </ion-label>
      </ion-item>
    </ion-list>
    <ng-template #profile>
      <swiper [pagination]="user?.images?.length" [config]="sliderOpts">
        <ng-template swiperSlide>
          <img
            [src]="user?.avatar"
            [alt]="user?.username"
            default="/assets/img/users/default.jpg"
          />
        </ng-template>
        <ng-template swiperSlide *ngFor="let image of user?.images">
          <img [src]="image" default="/assets/img/users/default.jpg" />
        </ng-template>
      </swiper>
      <div *ngIf="story" id="stories">
        <ion-avatar
          [ngClass]="story.viewed ? '' : 'not-view'"
          (click)="showStories(story.user.id)"
        >
          <img [src]="story.image" [alt]="story?.text" />
        </ion-avatar>
      </div>

      <div *ngIf="user.match" class="match full-center">{{ user.match }}%</div>

      <div class="ion-padding">
        <ion-list class="resume">
          <ion-item lines="none">
            <ion-icon
              slot="start"
              *ngIf="userSvc.getRoleIcon(user)"
              [name]="userSvc.getRoleIcon(user)"
              [src]="userSvc.getRoleIcon(user)"
              [color]="userSvc.getRoleColor(user)"
              (click)="userSvc.showRole(user)"
            ></ion-icon>
            <ion-label color="light">
              <span class="name">{{ user.name }}</span>
              <span *ngIf="user?.age" class="age">, {{ user.age }}</span>
              <ion-badge
                color="secondary"
                *ngIf="(user?.last_login | niceDate) === 'Ahora mismo'"
                >&nbsp;</ion-badge
              >
              <p>@{{user.username}}</p>
            </ion-label>
          </ion-item>
          <ion-item
            lines="none"
            id="kokoro"
            *ngIf="auth.currentUserValue && user?.likes && auth.isAdult()"
          >
            <ion-icon name="heart" slot="start" color="primary"></ion-icon>
            <ion-label>
              <span class="likes" (click)="showLikes('received')"
                ><strong>{{user.likes.received}}</strong> recibidos</span
              >
              &nbsp;&nbsp;&nbsp;&nbsp;
              <span class="likes" (click)="showLikes('delivered')"
                ><strong>{{user.likes.delivered}}</strong> entregados</span
              >
            </ion-label>
          </ion-item>
          <ion-item
            lines="none"
            class="location"
            *ngIf="auth.isAdult() && (user?.distance !== undefined || user?.ip)"
          >
            <ion-icon
              name="location-sharp"
              slot="start"
              color="secondary"
            ></ion-icon>
            <ion-label>
              <span *ngIf="user?.distance !== undefined"
                >A {{ user?.distance }}km de distancia
              </span>
              <span *ngIf="user?.ip"> ({{user?.ip}})</span>
            </ion-label>
          </ion-item>
          <ion-item lines="none" class="description" *ngIf="user?.description">
            <ion-icon name="document-text"></ion-icon>
            <ion-label
              [innerHTML]="
            user?.description | linky: { className: 'linkified' } | mentions | hashtag
          "
              (click)="$event.stopImmediatePropagation(); openUrl($event)"
            ></ion-label>
          </ion-item>
          <ion-item lines="none" *ngIf="user?.last_login">
            <ion-icon name="time"></ion-icon>
            <ion-label
              >Última conexión: {{ (user?.last_login | niceDate) === 'Ahora
              mismo' ? 'En línea' : (user?.last_login | niceDate) }}</ion-label
            >
          </ion-item>
          <ion-item lines="none" *ngIf="user?.register_date">
            <ion-icon name="calendar"></ion-icon>
            <ion-label
              >Fecha de registro: {{user?.register_date | niceDate }}</ion-label
            >
          </ion-item>
          <ion-item lines="none" *ngIf="user?.location">
            <ion-icon name="home"></ion-icon>
            <ion-label>{{ user.location }}</ion-label>
          </ion-item>
          <ion-item
            *ngIf="auth.isAdult() && (user?.gender || user?.pronoun || user?.orientation || user?.relationship)"
            lines="none"
          >
            <ion-icon name="body"></ion-icon>
            <ion-label>
              {{user?.orientation ? user.orientation + ' | ' : ''}} {{
              user?.gender ? user.gender : '' }} {{ user?.pronoun ? '(' +
              user.pronoun.toLowerCase() + ') | ' : '|'}} {{ user?.status ?
              user.status + ' | ' : ''}} {{ user?.relationship ?
              user.relationship : ''}}
            </ion-label>
          </ion-item>
          <ion-item *ngIf="auth.isAdult() && user?.connection?.length">
            <ion-icon name="search-outline"></ion-icon>
            <ion-label>Buscando: {{ user?.connection?.join(", ") }}</ion-label>
          </ion-item>
        </ion-list>
        <ion-list class="tags">
          <ion-item *ngIf="getTagsCategory('games')?.length">
            <ion-icon name="game-controller-outline"></ion-icon>
            <ion-label class="ion-text-wrap">
              <ion-chip
                *ngFor="let tag of getTagsCategory('games')"
                color="secondary"
              >
                <ion-label (click)="showTag(tag)">{{ tag.name }}</ion-label>
              </ion-chip>
            </ion-label>
          </ion-item>
          <ion-item *ngIf="getTagsCategory('films')?.length">
            <ion-icon name="film-outline"></ion-icon>
            <ion-label class="ion-text-wrap">
              <ion-chip
                *ngFor="let tag of getTagsCategory('films')"
                color="secondary"
              >
                <ion-label (click)="showTag(tag)">{{ tag.name }}</ion-label>
              </ion-chip>
            </ion-label>
          </ion-item>
          <ion-item *ngIf="getTagsCategory('books')?.length">
            <ion-icon name="book-outline"></ion-icon>
            <ion-label class="ion-text-wrap">
              <ion-chip
                *ngFor="let tag of getTagsCategory('books')"
                color="secondary"
              >
                <ion-label (click)="showTag(tag)">{{ tag.name }}</ion-label>
              </ion-chip>
            </ion-label>
          </ion-item>
          <ion-item *ngIf="getTagsCategory('role')?.length">
            <ion-icon name="dice-outline"></ion-icon>
            <ion-label class="ion-text-wrap">
              <ion-chip
                *ngFor="let tag of getTagsCategory('role')"
                color="secondary"
              >
                <ion-label (click)="showTag(tag)">{{ tag.name }}</ion-label>
              </ion-chip>
            </ion-label>
          </ion-item>
          <ion-item *ngIf="getTagsCategory('music')?.length">
            <ion-icon name="headset-outline"></ion-icon>
            <ion-label class="ion-text-wrap">
              <ion-chip
                *ngFor="let tag of getTagsCategory('music')"
                color="secondary"
              >
                <ion-label (click)="showTag(tag)">{{ tag.name }}</ion-label>
              </ion-chip>
            </ion-label>
          </ion-item>
        </ion-list>
      </div>
    </ng-template>
  </div>
  <ng-template #noUser>
    <div class="full-center ion-padding">
      <ion-icon name="body"></ion-icon>
      <h2>No encontrado</h2>
      <p>
        El perfil de usuario que intentas ver no existe o se encuentra inactivo.
      </p>
    </div>
  </ng-template>
</ion-content>

<ion-footer
  class="ion-no-border"
  *ngIf="auth.currentUserValue?.id !== user?.id && user?.id !== 1"
>
  <ion-toolbar>
    <ion-buttons *ngIf="user">
      <ion-grid>
        <ion-row class="ion-align-items-center">
          <ion-col
            class="ion-text-center"
            *ngIf="auth.currentUserValue && auth.isAdult() && user?.age >= 18"
          >
            <ion-button (click)="hideProfile()">
              <ion-icon
                slot="icon-only"
                name="eye-off"
                color="danger"
              ></ion-icon>
            </ion-button>
          </ion-col>
          <ion-col class="ion-text-center">
            <ion-button
              *ngIf="!user?.block_messages || user.from_like"
              (click)="showChat()"
            >
              <ion-icon slot="icon-only" name="chatbubbles-outline"></ion-icon>
            </ion-button>
          </ion-col>
          <ion-col
            class="ion-text-center"
            *ngIf="!auth.currentUserValue || (auth.isAdult() && user?.age >= 18)"
          >
            <ion-button (click)="switchLike()">
              <ion-icon
                [@pulse]="user.like"
                slot="icon-only"
                [color]="user?.like ? 'primary' : 'light'"
                [name]="user?.like ? 'heart' : 'heart-outline'"
              ></ion-icon>
            </ion-button>
          </ion-col>
        </ion-row>
      </ion-grid>
    </ion-buttons>
  </ion-toolbar>
</ion-footer>
