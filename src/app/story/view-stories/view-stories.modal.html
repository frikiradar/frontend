<ion-header class="ion-no-border">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-button shape="round" (click)="showProfile(story?.user?.id)">
        <ion-avatar>
          <img [src]="story.user?.thumbnail" [alt]="story.user?.username" />
        </ion-avatar>
        <ion-label>
          <h2>
            {{ story.user.id !== auth.currentUserValue.id ? story.user?.username
            : 'Mi historia' }}
          </h2>
          <p>{{(story?.time_creation | niceDate)}}</p>
        </ion-label>
      </ion-button>
      <ion-icon
        *ngIf="userSvc.getRoleIcon(story.user)"
        [name]="userSvc.getRoleIcon(story.user)"
        [src]="userSvc.getRoleIcon(story.user)"
        slot="icon-only"
        size="small"
        [color]="userSvc.getRoleColor(story.user)"
        (click)="userSvc.showRole(story.user)"
      ></ion-icon>
    </ion-buttons>
    <ion-buttons slot="end">
      <ion-button
        *ngIf="story.user.id === auth.currentUserValue.id || auth.isMaster()"
        (click)="showOptions(story)"
      >
        <ion-icon slot="icon-only" name="ellipsis-horizontal"></ion-icon>
      </ion-button>
      <ion-button (click)="close()">
        <ion-icon slot="icon-only" name="close"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>
<ion-content>
  <swiper
    (slideChangeTransitionEnd)="slide()"
    (swiper)="setSwiperInstance($event)"
    (click)="tap($event)"
    (touchStart)="touchStart($event)"
    (touchEnd)="touchEnd($event)"
    [config]="slideOpts"
  >
    <ng-template swiperSlide *ngFor="let story of stories">
      <ion-card>
        <ion-thumbnail>
          <img [src]="story?.image" [alt]="story?.user.username" />
        </ion-thumbnail>
        <ion-card-content>
          <p
            (click)="$event.stopImmediatePropagation(); openUrl($event);"
            [innerHTML]="story.text | linky:{className: 'linkified'} | mentions:{mentions: story.mentions} | hashtag"
          ></p>
        </ion-card-content>
      </ion-card>
    </ng-template>
  </swiper>
  <ion-item lines="none" id="text-input">
    <ion-buttons
      ion-activatable
      *ngIf="story?.user?.id !== auth.currentUserValue.id"
    >
      <ion-button color="primary" (click)="switchLikeStory()">
        <ion-icon
          slot="icon-only"
          [name]="story?.like ? 'heart' : 'heart-outline'"
        ></ion-icon>
      </ion-button>
    </ion-buttons>
    <form [formGroup]="commentForm" autocomplete="off">
      <ion-item lines="none">
        <ion-textarea
          placeholder="Comenta la historia"
          autocapitalize="on"
          (ionFocus)="commentFocus()"
          rows="1"
        >
        </ion-textarea>
      </ion-item>
    </form>
    <ion-buttons ion-activatable>
      <ion-button [disabled]="!comment.value" (click)="sendComment()">
        <ion-icon slot="icon-only" color="primary" name="send"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-item>
  <div class="comments">
    <ion-list *ngIf="story?.comments.length > 0">
      <ion-item
        *ngFor="let comment of story.comments.slice(-1)"
        button
        detail="false"
        lines="none"
      >
        <ion-avatar (click)="showProfile(comment.user.id)">
          <img [src]="comment.user.thumbnail" />
        </ion-avatar>
        <ion-label>
          <p class="text">
            <a (click)="showProfile(comment.user.id)"
              >{{comment.user.username}}</a
            >
            &nbsp;
            <span
              [innerHTML]="comment.text | linky:{className: 'linkified'} | mentions:{mentions: comment.mentions} | hashtag"
              (click)="$event.stopImmediatePropagation(); openUrl($event);"
            ></span>
          </p>

          <ion-note class="note-date">
            <span>{{ comment.time_creation | date: "shortTime" }}</span>
            &nbsp;&nbsp;&nbsp;
            <span
              *ngIf="comment?.likes.length"
              button
              (click)="viewCommentLikes(comment.likes)"
              >{{ comment.likes.length }} kokoros</span
            >
            &nbsp;&nbsp;&nbsp;
            <span
              *ngIf="auth.currentUserValue.id !== comment.user.id"
              button
              (click)="commentFocus(); reply(comment)"
              >Responder</span
            >
            &nbsp;&nbsp;&nbsp;
            <span
              *ngIf="auth.currentUserValue.id === comment.user.id"
              button
              (click)="deleteComment(comment)"
              >Eliminar</span
            >
          </ion-note>
        </ion-label>

        <ion-note>
          <ion-buttons>
            <ion-button (click)="switchLikeComment(comment)">
              <ion-icon
                slot="icon-only"
                size="small"
                [color]="comment.like ? 'primary' : 'medium'"
                [name]="comment.like ? 'heart' : 'heart-outline'"
              ></ion-icon>
            </ion-button>
          </ion-buttons>
        </ion-note>
      </ion-item>
      <ion-item
        button
        lines="none"
        class="show-more"
        (click)="viewComments()"
        *ngIf="story?.comments?.length > 1"
      >
        <ion-label>Ver los {{story?.comments.length}} comentarios</ion-label>
      </ion-item>
    </ion-list>
  </div>
</ion-content>
<ion-footer class="ion-no-border">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-button (click)="viewViews()" shape="round">
        <ion-icon name="heart"></ion-icon>
        <ion-label>{{story?.likeStories.length}} kokoros</ion-label> /
        <ion-label>{{story?.viewStories.length}} vistas</ion-label>
      </ion-button>
    </ion-buttons>
    <ion-buttons slot="end">
      <ion-button (click)="viewComments()" shape="round">
        <ion-icon name="chatbubble-ellipses"></ion-icon>
        <ion-label>{{story.comments.length}} Comentarios</ion-label>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-footer>

<!-- panes -->

<div class="views-pane">
  <p>Visualizaciones y kokoros</p>
  <ion-list *ngIf="story?.viewStories?.length > 0">
    <ion-item
      *ngFor="let view of story?.viewStories"
      button
      detail="false"
      (click)="showProfile(view.user.id)"
    >
      <ion-avatar>
        <img [src]="view?.user?.thumbnail" />
      </ion-avatar>
      <ion-label>{{view?.user?.username}}</ion-label>
      <ion-icon name="heart" color="primary" *ngIf="view?.user?.like"
        >{{view?.user?.like}}</ion-icon
      >
    </ion-item>
  </ion-list>
  <ion-item *ngIf="story?.viewStories?.length == 0">
    <p>No hay visualizaciones</p>
  </ion-item>
</div>
<div class="comments-pane">
  <p>Comentarios</p>
  <ion-list
    id="usernames"
    *ngIf="usernames?.length && comment?.value?.length > 3"
  >
    <ion-item
      lines="none"
      button
      detail="false"
      *ngFor="let u of usernames"
      (click)="setMention(u.username)"
    >
      <ion-avatar>
        <img [src]="u.thumbnail" />
      </ion-avatar>
      <ion-label>{{ u.username }}</ion-label>
    </ion-item>
  </ion-list>
  <ion-list *ngIf="story?.comments.length > 0">
    <ion-item
      *ngFor="let comment of story.comments"
      button
      detail="false"
      lines="none"
    >
      <ion-avatar (click)="showProfile(comment.user.id)">
        <img [src]="comment.user.thumbnail" />
      </ion-avatar>
      <ion-label>
        <p class="text">
          <a (click)="showProfile(comment.user.id)"
            >{{comment.user.username}}</a
          >
          &nbsp;
          <span
            [innerHTML]="comment.text | linky:{className: 'linkified'} | mentions:{mentions: comment.mentions} | hashtag"
            (click)="$event.stopImmediatePropagation(); openUrl($event);"
          ></span>
        </p>

        <ion-note class="note-date">
          <span>{{ comment.time_creation | date: "shortTime" }}</span>
          &nbsp;&nbsp;&nbsp;
          <span
            *ngIf="comment?.likes.length"
            button
            (click)="viewCommentLikes(comment.likes)"
            >{{ comment.likes.length }} kokoros</span
          >
          &nbsp;&nbsp;&nbsp;
          <span
            *ngIf="auth.currentUserValue.id !== comment.user.id"
            button
            (click)="reply(comment)"
            >Responder</span
          >
          &nbsp;&nbsp;&nbsp;
          <span
            *ngIf="auth.currentUserValue.id === comment.user.id"
            button
            (click)="deleteComment(comment)"
            >Eliminar</span
          >
        </ion-note>
      </ion-label>

      <ion-note>
        <ion-buttons>
          <ion-button (click)="switchLikeComment(comment)">
            <ion-icon
              slot="icon-only"
              size="small"
              [color]="comment.like ? 'primary' : 'medium'"
              [name]="comment.like ? 'heart' : 'heart-outline'"
            ></ion-icon>
          </ion-button>
        </ion-buttons>
      </ion-note>
    </ion-item>
  </ion-list>
  <ion-item *ngIf="story?.comments.length == 0">
    <p>No hay comentarios</p>
  </ion-item>
  <ion-footer>
    <ion-item id="comment-input" lines="none">
      <ion-avatar>
        <img
          [src]="auth.currentUserValue.thumbnail"
          [alt]="auth.currentUserValue.username"
        />
      </ion-avatar>
      <form [formGroup]="commentForm" autocomplete="off">
        <ion-item lines="none">
          <ion-textarea
            placeholder="Comenta la historia"
            autocapitalize="on"
            (keydown.enter)="sendComment($event)"
            (ionChange)="setWriting($event.detail.value)"
            formControlName="comment"
            #textarea
            rows="1"
          >
          </ion-textarea>
        </ion-item>
      </form>
      <ion-buttons ion-activatable>
        <ion-button [disabled]="!comment.value" (click)="sendComment()">
          <ion-icon slot="icon-only" name="send" color="primary"></ion-icon>
        </ion-button>
      </ion-buttons>
    </ion-item>
  </ion-footer>
</div>
