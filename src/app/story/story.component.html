<div class="story-container">
  <img
    *ngIf="story?.image"
    class="background-image"
    [src]="story?.image"
    [alt]="story?.user.username"
  />

  <ion-card *ngIf="story.image">
    <ion-thumbnail>
      <img [src]="story?.image" [alt]="story?.user.username" />
    </ion-thumbnail>
    <ion-card-content *ngIf="story.text || story?.comments.length > 0">
      <p
        (click)="$event.stopImmediatePropagation(); openUrl($event)"
        [innerHTML]="
          story.text
            | linky : { className: 'linkified' }
            | mentions : { mentions: story.mentions }
            | hashtag
        "
      ></p>
      <div class="comments preview-comments">
        <ion-list *ngIf="story?.comments.length > 0">
          <ion-item
            *ngFor="let comment of story.comments.slice(-1)"
            button
            detail="false"
            lines="none"
          >
            <ion-avatar (click)="showProfile(comment.user.id)">
              <img [src]="comment.user.thumbnail" />
            </ion-avatar>
            <ion-label>
              <p class="text">
                <a (click)="showProfile(comment.user.id)">{{
                  comment.user.username
                }}</a>
                &nbsp;
                <span
                  [innerHTML]="
                    comment.text
                      | linky : { className: 'linkified' }
                      | mentions : { mentions: comment.mentions }
                      | hashtag
                  "
                  (click)="$event.stopImmediatePropagation(); openUrl($event)"
                ></span>
              </p>

              <ion-note class="note-date">
                <span>{{ comment.time_creation | date : "shortTime" }}</span>
                &nbsp;&nbsp;&nbsp;
                <span
                  *ngIf="comment?.likes.length"
                  button
                  (click)="viewCommentLikes(comment.likes)"
                  >{{ comment.likes.length }} kokoros</span
                >
              </ion-note>
            </ion-label>
          </ion-item>
          <ion-item
            button
            lines="none"
            class="show-more"
            (click)="
              $event.stopImmediatePropagation(); showCommentsSheet($event)
            "
          >
            <ion-label>{{
              "view-comments" | i18n : { comments: story?.comments.length }
            }}</ion-label>
          </ion-item>
        </ion-list>
      </div>
    </ion-card-content>
  </ion-card>
  <div
    *ngIf="!story.image"
    class="story-text-container"
    [ngClass]="story.color == '#CFD8DC' ? 'dark' : 'light'"
  >
    <ion-thumbnail class="youtube" *ngIf="story.youtube">
      <iframe [src]="story.youtube" frameborder="0" allowfullscreen></iframe>
    </ion-thumbnail>
    <span
      class="story-text"
      [innerHTML]="
        story.text
          | linky : { className: 'linkified' }
          | mentions : { mentions: story.mentions }
          | hashtag
      "
      (click)="$event.stopImmediatePropagation(); openUrl($event)"
    ></span>
  </div>
  <div class="background-color" [ngStyle]="{ background: story.color }"></div>
  <div class="story-actions">
    <ion-buttons slot="start" ion-activatable>
      <ion-button
        color="primary"
        (click)="switchLikeStory($event)"
        shape="round"
      >
        <ion-icon
          [color]="story?.like ? 'primary' : ''"
          [name]="story?.like ? 'heart' : 'heart-outline'"
          [@pulse]="story.like"
        ></ion-icon>
      </ion-button>
    </ion-buttons>
    <ion-label>{{ story?.likeStories.length }}</ion-label>
    <ion-buttons slot="end">
      <ion-button
        (click)="showCommentsSheet($event)"
        id="view-comments"
        shape="round"
      >
        <ion-icon name="chatbubble-ellipses"></ion-icon>
      </ion-button>
    </ion-buttons>
    <ion-label>{{ story.comments.length }}</ion-label>
    <ion-buttons>
      <ion-button
        (click)="showViewsSheet($event)"
        id="view-views"
        shape="round"
      >
        <ion-icon name="stats-chart"></ion-icon>
      </ion-button>
    </ion-buttons>
    <ion-label>{{ story?.viewStories.length }}</ion-label>
  </div>
  <ion-chip (click)="showPage(story.slug)" *ngIf="story.slug" class="story-slug"
    >#{{ story.slug }}</ion-chip
  >
</div>

<!-- modals -->
<ion-modal
  [breakpoints]="[0, 1]"
  [initialBreakpoint]="1"
  cssClass="sheet-modal"
  (didPresent)="stopSlide()"
  (didDismiss)="startSlide()"
  [isOpen]="showViews"
  (ionModalDidDismiss)="closeViewsSheet()"
>
  <ng-template>
    <ion-content class="ion-padding">
      <p>{{ "visualizaciones-kokoros" | i18n }}</p>
      <ion-list *ngIf="story?.viewStories?.length > 0">
        <ion-item
          *ngFor="let view of story?.viewStories"
          button
          detail="false"
          (click)="showProfile(view.user.id)"
          color="dark"
        >
          <ion-avatar>
            <img [src]="view?.user?.thumbnail" />
          </ion-avatar>
          <ion-label>{{ view?.user?.username }}</ion-label>
          <ion-icon name="heart" color="primary" *ngIf="view?.user?.like">{{
            view?.user?.like
          }}</ion-icon>
        </ion-item>
      </ion-list>
      <ion-item *ngIf="story?.viewStories?.length == 0" color="dark">
        <p>{{ "no-hay-visualizaciones" | i18n }}</p>
      </ion-item>
    </ion-content>
  </ng-template>
</ion-modal>

<ion-modal
  [breakpoints]="[0, 1]"
  [initialBreakpoint]="1"
  cssClass="sheet-modal"
  (didPresent)="stopSlide()"
  (didDismiss)="startSlide()"
  [isOpen]="showComments"
  (ionModalDidDismiss)="closeCommentsSheet()"
>
  <ng-template>
    <ion-content class="comments-modal">
      <p class="ion-padding">{{ "comentarios" | i18n }}</p>
      <ion-list
        id="usernames"
        *ngIf="usernames?.length && textarea?.value?.length > 3"
      >
        <ion-item
          lines="none"
          button
          detail="false"
          *ngFor="let u of usernames"
          (click)="setMention(u.username)"
        >
          <ion-avatar>
            <img [src]="u.thumbnail" />
          </ion-avatar>
          <ion-label>{{ u.username }}</ion-label>
        </ion-item>
      </ion-list>
      <ion-list *ngIf="story?.comments.length > 0">
        <ion-item
          *ngFor="let comment of story.comments"
          button
          detail="false"
          lines="none"
          color="dark"
          (press)="showCommentOptionsSheet(comment)"
        >
          <ion-avatar (click)="showProfile(comment.user.id)">
            <img [src]="comment.user.thumbnail" />
          </ion-avatar>
          <ion-label>
            <p class="text">
              <a (click)="showProfile(comment.user.id)">{{
                comment.user.username
              }}</a>
              &nbsp;
              <span
                [innerHTML]="
                  comment.text
                    | linky : { className: 'linkified' }
                    | mentions : { mentions: comment.mentions }
                    | hashtag
                "
                (click)="$event.stopImmediatePropagation(); openUrl($event)"
              ></span>
            </p>

            <ion-note class="note-date">
              <span>{{ comment.time_creation | date : "shortTime" }}</span>
              &nbsp;&nbsp;&nbsp;
              <span
                *ngIf="comment?.likes.length"
                button
                (click)="viewCommentLikes(comment.likes)"
                >{{ comment.likes.length }} kokoros</span
              >
              &nbsp;&nbsp;&nbsp;
              <span
                *ngIf="auth.currentUserValue.id !== comment.user.id"
                button
                (click)="reply(comment)"
                >{{ "reply" | i18n }}</span
              >
            </ion-note>
          </ion-label>

          <ion-note>
            <ion-buttons>
              <ion-button (click)="switchLikeComment(comment)">
                <ion-icon
                  slot="icon-only"
                  size="small"
                  [color]="comment.like ? 'primary' : 'medium'"
                  [name]="comment.like ? 'heart' : 'heart-outline'"
                ></ion-icon>
              </ion-button>
            </ion-buttons>
          </ion-note>
        </ion-item>
      </ion-list>
      <ion-item *ngIf="story?.comments.length == 0" color="dark">
        <p>{{ "no-hay-comentarios" | i18n }}</p>
      </ion-item>
    </ion-content>
    <ion-footer>
      <ion-item id="comment-input" lines="none">
        <ion-avatar slot="start">
          <img
            [src]="auth.currentUserValue.thumbnail"
            [alt]="auth.currentUserValue.username"
          />
        </ion-avatar>
        <ion-item lines="none">
          <ion-textarea
            placeholder="{{ 'comment-story' | i18n }}"
            autocapitalize="on"
            (keydown.enter)="sendComment($event)"
            (ionInput)="setWriting($event.detail.value)"
            #textarea
            rows="1"
          >
          </ion-textarea>
        </ion-item>
        <ion-buttons ion-activatable slot="end">
          <ion-button [disabled]="!textarea.value" (click)="sendComment()">
            <ion-icon slot="icon-only" name="send" color="primary"></ion-icon>
          </ion-button>
        </ion-buttons>
      </ion-item>
    </ion-footer>
  </ng-template>
</ion-modal>

<ion-modal
  [initialBreakpoint]="0.4"
  [breakpoints]="[0, 0.4, 0.6]"
  [isOpen]="showOptions"
  cssClass="sheet-modal"
  (didPresent)="stopSlide()"
  (didDismiss)="startSlide()"
>
  <ng-template>
    <ion-content class="ion-padding">
      <ion-list>
        <ion-item
          button
          detail="false"
          (click)="removeStory($event)"
          lines="none"
          *ngIf="story.user.id === auth.currentUserValue.id || auth.isMaster()"
        >
          <ion-icon slot="start" name="trash-outline" color="light"></ion-icon>
          <ion-label>{{ "eliminar-historia" | i18n }}</ion-label>
        </ion-item>
        <ion-item
          lines="none"
          button
          detail="false"
          (click)="reportStory($event)"
        >
          <ion-icon
            slot="start"
            name="warning-outline"
            color="light"
          ></ion-icon>
          <ion-label>{{ "reportar-historia" | i18n }}</ion-label>
        </ion-item>
        <ion-item
          lines="none"
          button
          detail="false"
          (click)="blockUser()"
          *ngIf="story.user.id !== auth.currentUserValue.id"
        >
          <ion-icon slot="start" name="ban" color="light"></ion-icon>
          <ion-label>{{ "block-user" | i18n }}</ion-label>
        </ion-item>
      </ion-list>
    </ion-content>
  </ng-template>
</ion-modal>

<ion-modal
  [initialBreakpoint]="0.4"
  [breakpoints]="[0, 0.4, 0.6]"
  cssClass="sheet-modal"
  [isOpen]="showCommentOptions"
  (ionModalDidDismiss)="closeCommentOptionsSheet()"
>
  <ng-template>
    <ion-content class="ion-padding">
      <ion-list>
        <ion-item
          button
          detail="false"
          (click)="deleteComment(selectedComment)"
          lines="none"
          *ngIf="
            selectedComment.user.id === auth.currentUserValue.id ||
            auth.isMaster()
          "
        >
          <ion-icon slot="start" name="trash-outline" color="light"></ion-icon>
          <ion-label>{{ "delete" | i18n }}</ion-label>
        </ion-item>
        <ion-item
          lines="none"
          button
          detail="false"
          (click)="reportComment(selectedComment)"
          *ngIf="selectedComment.user.id !== auth.currentUserValue.id"
        >
          <ion-icon
            slot="start"
            name="warning-outline"
            color="light"
          ></ion-icon>
          <ion-label>{{ "report-comment" | i18n }}</ion-label>
        </ion-item>
        <ion-item
          lines="none"
          button
          detail="false"
          (click)="blockUser(selectedComment.user)"
          *ngIf="selectedComment.user.id !== auth.currentUserValue.id"
        >
          <ion-icon slot="start" name="ban" color="light"></ion-icon>
          <ion-label>{{ "block-user" | i18n }}</ion-label>
        </ion-item>
      </ion-list>
    </ion-content>
  </ng-template>
</ion-modal>
