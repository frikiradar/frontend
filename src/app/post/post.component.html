<div #postElement>
  <ion-card>
    <ion-card-header>
      <ion-label
        *ngIf="post.slug"
        class="post-slug"
        (click)="showPage(post.slug)"
        class="post-slug"
        >#{{ post.slug }}</ion-label
      >
      <ion-item lines="none" button>
        <ion-avatar slot="start" (click)="showProfile()">
          <img [src]="post?.user?.thumbnail" [alt]="post?.user?.name" />
        </ion-avatar>
        <ion-label>
          <h2 class="post-name">{{ post?.user?.name }}</h2>
          <p class="post-username">&#64;{{ post?.user?.username }}</p>
          <ion-note class="post-date">
            Â· {{ post?.time_creation | chatDate }}</ion-note
          >
        </ion-label>
        <ion-buttons slot="end" class="post-options">
          <ion-button (click)="showOptionsSheet()" fill="clear" color="light">
            <ion-icon slot="icon-only" name="ellipsis-vertical"></ion-icon>
          </ion-button>
        </ion-buttons>
      </ion-item>
    </ion-card-header>
    <ion-card-content>
      <ion-thumbnail *ngIf="post.image">
        <ion-img
          [src]="post?.image"
          [alt]="post?.text"
          (click)="openViewer()"
        ></ion-img>
      </ion-thumbnail>
      <p
        [innerHTML]="
          post?.text | linky : { className: 'linkified' } | mentions | hashtag
        "
      ></p>
      <ion-note slot="end"></ion-note>
      <ion-buttons>
        <ion-row class="ion-align-items-center">
          <ion-col class="ion-text-center">
            <ion-button
              fill="clear"
              shape="round"
              color="light"
              (click)="switchLikePost($event)"
            >
              <ion-icon
                [name]="post.like ? 'heart' : 'heart-outline'"
                [color]="post.like ? 'primary' : ''"
                slot="start"
              ></ion-icon>
              <ion-label>{{ post?.likeStories.length }}</ion-label>
            </ion-button>
          </ion-col>
          <ion-col class="ion-text-center">
            <ion-button
              fill="clear"
              shape="round"
              color="light"
              (click)="showCommentsSheet($event)"
            >
              <ion-icon name="chatbubble-ellipses" slot="start"></ion-icon>
              <ion-label>{{ post.comments.length }}</ion-label>
            </ion-button>
          </ion-col>
          <ion-col class="ion-text-center">
            <ion-button
              fill="clear"
              shape="round"
              color="light"
              (click)="showViewsSheet($event)"
            >
              <ion-icon name="stats-chart" slot="start"></ion-icon>
              <ion-label>{{ post.viewStories.length }}</ion-label>
            </ion-button>
          </ion-col>
        </ion-row>
      </ion-buttons>
    </ion-card-content>
  </ion-card>
</div>

<!-- modals -->
<ion-modal
  [breakpoints]="[0, 1]"
  [initialBreakpoint]="1"
  cssClass="sheet-modal"
  [isOpen]="showViews"
  (ionModalDidDismiss)="closeViewsSheet()"
>
  <ng-template>
    <ion-content class="ion-padding">
      <p>{{ "visualizaciones-kokoros" | i18n }}</p>
      <ion-list *ngIf="post?.viewStories?.length > 0">
        <ion-item
          *ngFor="let view of post?.viewStories"
          button
          detail="false"
          (click)="showProfile(view.user.id)"
          color="dark"
        >
          <ion-avatar>
            <img [src]="view?.user?.thumbnail" />
          </ion-avatar>
          <ion-label>{{ view?.user?.username }}</ion-label>
          <ion-icon name="heart" color="primary" *ngIf="view?.user?.like">{{
            view?.user?.like
          }}</ion-icon>
        </ion-item>
      </ion-list>
      <ion-item *ngIf="post?.viewStories?.length == 0" color="dark">
        <p>{{ "no-hay-visualizaciones" | i18n }}</p>
      </ion-item>
    </ion-content>
  </ng-template>
</ion-modal>

<ion-modal
  [breakpoints]="[0, 1]"
  [initialBreakpoint]="1"
  cssClass="sheet-modal"
  [isOpen]="showComments"
  (ionModalDidDismiss)="closeCommentsSheet()"
>
  <ng-template>
    <ion-content class="comments-modal">
      <p class="ion-padding">{{ "comentarios" | i18n }}</p>
      <ion-list
        id="usernames"
        *ngIf="usernames?.length && textarea?.value?.length > 3"
      >
        <ion-item
          lines="none"
          button
          detail="false"
          *ngFor="let u of usernames"
          (click)="setMention(u.username)"
        >
          <ion-avatar>
            <img [src]="u.thumbnail" />
          </ion-avatar>
          <ion-label>{{ u.username }}</ion-label>
        </ion-item>
      </ion-list>
      <ion-list *ngIf="post?.comments.length > 0">
        <ion-item
          *ngFor="let comment of post.comments"
          button
          detail="false"
          lines="none"
          color="dark"
          (press)="showCommentOptionsSheet(comment)"
        >
          <ion-avatar (click)="showProfile(comment.user.id)">
            <img [src]="comment.user.thumbnail" />
          </ion-avatar>
          <ion-label>
            <p class="text">
              <a (click)="showProfile(comment.user.id)">{{
                comment.user.username
              }}</a>
              &nbsp;
              <span
                [innerHTML]="
                  comment.text
                    | linky : { className: 'linkified' }
                    | mentions : { mentions: comment.mentions }
                    | hashtag
                "
                (click)="$event.stopImmediatePropagation(); openUrl($event)"
              ></span>
            </p>

            <ion-note class="note-date">
              <span>{{ comment.time_creation | date : "shortTime" }}</span>
              &nbsp;&nbsp;&nbsp;
              <span
                *ngIf="comment?.likes.length"
                button
                (click)="viewCommentLikes(comment.likes)"
                >{{ comment.likes.length }} kokoros</span
              >
              &nbsp;&nbsp;&nbsp;
              <span
                *ngIf="auth.currentUserValue.id !== comment.user.id"
                button
                (click)="reply(comment)"
                >{{ "reply" | i18n }}</span
              >
            </ion-note>
          </ion-label>

          <ion-note>
            <ion-buttons>
              <ion-button (click)="switchLikeComment(comment)">
                <ion-icon
                  slot="icon-only"
                  size="small"
                  [color]="comment.like ? 'primary' : 'medium'"
                  [name]="comment.like ? 'heart' : 'heart-outline'"
                ></ion-icon>
              </ion-button>
            </ion-buttons>
          </ion-note>
        </ion-item>
      </ion-list>
      <ion-item *ngIf="post?.comments.length == 0" color="dark">
        <p>{{ "no-hay-comentarios" | i18n }}</p>
      </ion-item>
    </ion-content>
    <ion-footer>
      <ion-item id="comment-input" lines="none">
        <ion-avatar slot="start">
          <img
            [src]="auth.currentUserValue.thumbnail"
            [alt]="auth.currentUserValue.username"
          />
        </ion-avatar>
        <ion-item lines="none">
          <ion-textarea
            placeholder="{{ 'comment-post' | i18n }}"
            autocapitalize="on"
            (keydown.enter)="sendComment($event)"
            (ionInput)="setWriting($event.detail.value)"
            #textarea
            rows="1"
          >
          </ion-textarea>
        </ion-item>
        <ion-buttons ion-activatable slot="end">
          <ion-button [disabled]="!textarea.value" (click)="sendComment()">
            <ion-icon slot="icon-only" name="send" color="primary"></ion-icon>
          </ion-button>
        </ion-buttons>
      </ion-item>
    </ion-footer>
  </ng-template>
</ion-modal>

<ion-modal
  [initialBreakpoint]="0.4"
  [breakpoints]="[0, 0.4, 0.6]"
  cssClass="sheet-modal"
  [isOpen]="showOptions"
  (didDismiss)="closeOptionsSheet()"
>
  <ng-template>
    <ion-content class="ion-padding">
      <ion-list>
        <ion-item
          button
          detail="false"
          (click)="removePost()"
          lines="none"
          *ngIf="post.user.id === auth.currentUserValue.id || auth.isMaster()"
        >
          <ion-icon slot="start" name="trash-outline" color="light"></ion-icon>
          <ion-label>{{ "delete-post" | i18n }}</ion-label>
        </ion-item>
        <ion-item lines="none" button detail="false" (click)="reportPost()">
          <ion-icon
            slot="start"
            name="warning-outline"
            color="light"
          ></ion-icon>
          <ion-label>{{ "report-post" | i18n }}</ion-label>
        </ion-item>
        <ion-item
          lines="none"
          button
          detail="false"
          (click)="blockUser(post.user)"
          *ngIf="post.user.id !== auth.currentUserValue.id"
        >
          <ion-icon slot="start" name="ban" color="light"></ion-icon>
          <ion-label>{{ "block-user" | i18n }}</ion-label>
        </ion-item>
      </ion-list>
    </ion-content>
  </ng-template>
</ion-modal>

<ion-modal
  [initialBreakpoint]="0.4"
  [breakpoints]="[0, 0.4, 0.6]"
  cssClass="sheet-modal"
  [isOpen]="showCommentOptions"
  (ionModalDidDismiss)="closeCommentOptionsSheet()"
>
  <ng-template>
    <ion-content class="ion-padding">
      <ion-list>
        <ion-item
          button
          detail="false"
          (click)="deleteComment(selectedComment)"
          lines="none"
          *ngIf="
            selectedComment.user.id === auth.currentUserValue.id ||
            auth.isMaster()
          "
        >
          <ion-icon slot="start" name="trash-outline" color="light"></ion-icon>
          <ion-label>{{ "delete" | i18n }}</ion-label>
        </ion-item>
        <ion-item
          lines="none"
          button
          detail="false"
          (click)="reportComment(selectedComment)"
        >
          <ion-icon
            slot="start"
            name="warning-outline"
            color="light"
          ></ion-icon>
          <ion-label>{{ "report-comment" | i18n }}</ion-label>
        </ion-item>
        <ion-item
          lines="none"
          button
          detail="false"
          (click)="blockUser(selectedComment.user)"
          *ngIf="selectedComment.user.id !== auth.currentUserValue.id"
        >
          <ion-icon slot="start" name="ban" color="light"></ion-icon>
          <ion-label>{{ "block-user" | i18n }}</ion-label>
        </ion-item>
      </ion-list>
    </ion-content>
  </ng-template>
</ion-modal>
