<ion-content [fullscreen]="true">
  <ion-header class="ion-no-border">
    <ion-toolbar>
      <ion-buttons slot="start">
        <ion-button class="back" (click)="back()">
          <ion-icon slot="icon-only" name="arrow-back"></ion-icon>
        </ion-button>
      </ion-buttons>
      <ion-buttons slot="end">
        <ion-button
          *ngIf="user?.images?.length < 9"
          (click)="openPictureSheet()"
        >
          <ion-icon
            slot="icon-only"
            src="/assets/icon/add_a_photo_white_24dp.svg"
            size="large"
          ></ion-icon>
        </ion-button>
        <ion-button (click)="deleteImage()">
          <ion-icon slot="icon-only" name="trash-outline"></ion-icon>
        </ion-button>
        <ion-button (click)="setAvatar()">
          <ion-icon slot="icon-only" name="star-outline"></ion-icon>
        </ion-button>
      </ion-buttons>
    </ion-toolbar>
  </ion-header>
  <input
    type="file"
    accept="image/*"
    #imageInput
    style="display: none"
    name="avatar"
    (change)="cropImagebyEvent($event)"
    (click)="imageInput.value = null"
  />
  <ion-list *ngIf="loading">
    <ion-item lines="none">
      <ion-label>
        <h1>
          <ion-skeleton-text animated style="width: 75%"></ion-skeleton-text>
        </h1>
        <h3>
          <ion-skeleton-text animated style="width: 50%"></ion-skeleton-text>
        </h3>
      </ion-label>
    </ion-item>
    <ion-item lines="none">
      <ion-label>
        <span *ngFor="let i of [].constructor(20)">
          <p>
            <ion-skeleton-text animated style="width: 100%"></ion-skeleton-text>
          </p>
          <p>
            <ion-skeleton-text animated style="width: 95%"></ion-skeleton-text>
          </p>
        </span>
      </ion-label>
    </ion-item>
  </ion-list>
  <div *ngIf="!loading">
    <swiper-container
      id="swiper-edit-profile"
      (click)="tap($event)"
      scrollbar="true"
      modules="Scrollbar"
    >
      <swiper-slide>
        <img [src]="user?.avatar" default="/assets/img/users/default.png" />
      </swiper-slide>
      <swiper-slide *ngFor="let image of user?.images">
        <img [src]="image" default="/assets/img/users/default.png" />
      </swiper-slide>
    </swiper-container>
    <form [formGroup]="profileForm">
      <ion-list>
        <ion-item-group>
          <ion-item-divider color="primary">
            <ion-icon name="person-circle" slot="start"></ion-icon>
            <ion-label
              ><h2>{{ "mi-informacin-personal" | i18n }}</h2></ion-label
            >
          </ion-item-divider>
          <ion-item>
            <ion-icon name="person" slot="start"></ion-icon>
            <ion-input
              label="{{ 'name' | i18n }}"
              labelPlacement="floating"
              formControlName="name"
              autocapitalize="on"
              [autoGrow]="true"
            ></ion-input>
          </ion-item>
          <ion-item id="description" lines="none">
            <ion-icon name="document-text" slot="start"></ion-icon>
            <ion-textarea
              label="{{ 'mensaje-presentacin' | i18n }}"
              labelPlacement="floating"
              formControlName="description"
              autocapitalize="on"
              [autoGrow]="true"
              [counter]="true"
              maxlength="500"
            ></ion-textarea>
          </ion-item>
          <ion-item>
            <ion-icon name="home" slot="start"></ion-icon>
            <ion-input
              label="{{ 'vivo-en' | i18n }}"
              labelPlacement="floating"
              formControlName="location"
              autocapitalize="on"
              [autoGrow]="true"
            ></ion-input>
          </ion-item>

          <ion-item button id="open-calendar">
            <ion-icon name="calendar" slot="start"></ion-icon>
            <ion-label class="ion-text-wrap"
              >{{ "fecha-nacimiento" | i18n }}
              <ion-text color="primary"
                >{{ profileForm.get("birthday").value | niceDate }}</ion-text
              ></ion-label
            >
          </ion-item>
          <ion-modal trigger="open-calendar" cssClass="date-modal">
            <ng-template>
              <ion-datetime
                formControlName="birthday"
                presentation="date"
                [locale]="user.language"
                [first-day-of-week]="user.language == 'es' ? 1 : 0"
                min="1900-01-01"
                max="{{ (today | date: 'y') - 18 }}-{{ today | date: 'MM' }}-{{
            today | date: 'dd'
          }}"
              >
              </ion-datetime>
            </ng-template>
          </ion-modal>
          <ion-item>
            <ion-icon name="language" slot="start"></ion-icon>
            <ion-select
              label="{{ 'idiomas-que-hablo' | i18n }}"
              labelPlacement="floating"
              cancelText="{{ 'cancelar' | i18n }}"
              placeholder="Selecciona"
              formControlName="languages"
              multiple
            >
              <ion-select-option
                *ngFor="let language of languages"
                [value]="language.value"
                >{{ language.name | i18n }}</ion-select-option
              >
            </ion-select>
          </ion-item>
        </ion-item-group>
        <ion-item-group>
          <ion-item-divider color="primary">
            <ion-icon name="location" slot="start"></ion-icon>
            <ion-label>
              <h2>{{ "informacin-radar" | i18n }}</h2>
              <p class="ion-text-wrap">
                {{ "informacin-necesaria-para-que-usuarios" | i18n}}
              </p>
            </ion-label>
          </ion-item-divider>
          <ion-item>
            <ion-select
              label="{{'identidad-gnero' | i18n}}"
              labelPlacement="floating"
              interface="action-sheet"
              cancelText="{{ 'cancelar' | i18n }}"
              placeholder="{{ 'selecciona-uno' | i18n }}"
              formControlName="gender"
            >
              <ion-select-option
                *ngFor="let gender of userSvc.getGenders()"
                [value]="gender"
                >{{ gender | i18n }}
              </ion-select-option>
            </ion-select>
          </ion-item>
          <ion-item>
            <ion-select
              label="{{ 'orientacion-sexual' | i18n }}"
              labelPlacement="floating"
              interface="action-sheet"
              cancelText="{{ 'cancelar' | i18n }}"
              placeholder="{{ 'selecciona-uno' | i18n }}"
              formControlName="orientation"
            >
              <ion-select-option
                *ngFor="let orientation of userSvc.getOrientations()"
                [value]="orientation"
              >
                {{ orientation | i18n }}</ion-select-option
              >
            </ion-select>
          </ion-item>
          <ion-item>
            <ion-select
              label="{{ 'pronombre' | i18n }}"
              labelPlacement="floating"
              interface="action-sheet"
              cancelText="{{ 'cancelar' | i18n }}"
              placeholder="{{ 'selecciona-uno' | i18n }}"
              formControlName="pronoun"
              value=""
            >
              <ion-select-option value=""
                >{{ "sin-indicar" | i18n }}</ion-select-option
              >
              <ion-select-option
                *ngFor="let pronoun of userSvc.getPronouns()"
                [value]="pronoun"
                >{{ pronoun | i18n }}
              </ion-select-option>
            </ion-select>
          </ion-item>
          <ion-item>
            <ion-select
              label="{{ 'tipo-de-relacion' | i18n }}"
              labelPlacement="floating"
              interface="action-sheet"
              cancelText="{{ 'cancelar' | i18n }}"
              placeholder="{{ 'selecciona-uno' | i18n }}"
              formControlName="relationship"
              value=""
            >
              <ion-select-option value=""
                >{{ "sin-indicar" | i18n }}</ion-select-option
              >
              <ion-select-option
                *ngFor="let type of userSvc.getRelationships()"
                [value]="type"
                >{{ type | i18n }}
              </ion-select-option>
            </ion-select>
          </ion-item>
          <ion-item>
            <ion-select
              label="{{ 'estado' | i18n }}"
              labelPlacement="floating"
              interface="action-sheet"
              cancelText="{{ 'cancelar' | i18n }}"
              placeholder="{{ 'selecciona-uno' | i18n }}"
              formControlName="status"
              value=""
            >
              <ion-select-option value=""
                >{{ "sin-indicar" | i18n }}</ion-select-option
              >
              <ion-select-option
                *ngFor="let status of userSvc.getStatus()"
                [value]="status"
                >{{ status | i18n }}
              </ion-select-option>
            </ion-select>
          </ion-item>
        </ion-item-group>
        <ion-item-group>
          <ion-item-divider color="primary">
            <ion-icon name="search" slot="start"></ion-icon>
            <ion-label>
              <h2>{{ "estoy-buscando" | i18n }}</h2>
              <p class="ion-text-wrap">
                {{ "elige-tipo-persona-que-ests" | i18n}}
              </p>
            </ion-label>
          </ion-item-divider>
          <ion-item>
            <ion-select
              labelPlacement="floating"
              label="{{ 'identidad-gnero' | i18n }}"
              cancelText="{{ 'cancelar' | i18n }}"
              placeholder="Selecciona"
              formControlName="lovegender"
              multiple
            >
              <ion-select-option
                *ngFor="let likegender of userSvc.getGenders()"
                [value]="likegender"
                >{{ likegender | i18n }}
              </ion-select-option>
            </ion-select>
          </ion-item>
          <ion-item class="ages" lines="full">
            <ion-input
              slot="start"
              label="{{ 'edad-desde' | i18n}} "
              labelPlacement="floating"
              type="text"
              formControlName="minage"
              readonly
              placeholder="{{ 'aos' | i18n }}"
              (click)="openPicker('minage')"
            >
            </ion-input>

            <ion-input
              labelPlacement="floating"
              label="- {{ 'edad-hasta' | i18n }}"
              type="text"
              formControlName="maxage"
              readonly
              placeholder="{{ 'aos' | i18n }}"
              (click)="openPicker('maxage')"
            >
            </ion-input>
          </ion-item>
          <ion-item>
            <ion-select
              labelPlacement="floating"
              label="{{ 'tipo-conexin' | i18n }}"
              cancelText="{{ 'cancelar' | i18n }}"
              placeholder="Selecciona"
              formControlName="connection"
              multiple
            >
              <ion-select-option
                *ngFor="let connection of userSvc.getConnections()"
                [value]="connection"
              >
                {{ connection | i18n }}</ion-select-option
              >
            </ion-select>
          </ion-item>
        </ion-item-group>
      </ion-list>
    </form>
  </div>
  <ion-list>
    <ion-item-group>
      <ion-item-divider color="primary">
        <ion-icon name="pricetags" slot="start"></ion-icon>
        <ion-label>
          <h2>{{ "etiquetas-gustos-frikis" | i18n }}</h2>
          <p class="ion-text-wrap">
            {{ "selecciona-uno-por-cada-etiqueta" | i18n}}
          </p>
        </ion-label>
      </ion-item-divider>
    </ion-item-group>
    <ion-item-group>
      <ion-item class="category-header" lines="full">
        <ion-icon slot="start" name="game-controller"></ion-icon>
        <ion-input
          aria-label="Videojuegos favoritos"
          #games
          placeholder="{{ 'videojuegos-favoritos' | i18n }}"
          clearInput="true"
          autocapitalize="words"
          (ionInput)="searchTag($event.detail.value, 'games')"
          (keyup.enter)="
                        addTag($event.target.value, 'games'); games.value = ''
                      "
          spellcheck="false"
        ></ion-input>
        <ion-icon
          name="add-circle"
          slot="end"
          (click)="addTag(games.value, 'games')"
        ></ion-icon>
      </ion-item>
      <ion-item lines="none">
        <ion-label class="ion-text-wrap">
          <ion-chip
            *ngFor="let tag of getTagsCategory('games')"
            color="secondary"
          >
            <ion-icon
              name="close-circle"
              (click)="removeTag(tag.id)"
            ></ion-icon>
            <ion-label>{{ tag.name }}</ion-label>
          </ion-chip>
        </ion-label>
      </ion-item>
    </ion-item-group>

    <ion-item-group>
      <ion-item class="category-header" lines="full">
        <ion-icon name="film" slot="start"></ion-icon>
        <ion-input
          aria-label="Películas, series o animes favoritos"
          #films
          placeholder="{{ 'peliculas-series-animes-favoritos' | i18n }}"
          clearInput="true"
          autocapitalize="words"
          (ionInput)="searchTag($event.detail.value, 'films')"
          [debounce]="500"
          (keyup.enter)="
                        addTag($event.target.value, 'films'); films.value = ''
                      "
        ></ion-input>
        <ion-icon
          name="add-circle"
          slot="end"
          (click)="addTag(films.value, 'films')"
        ></ion-icon>
      </ion-item>
      <ion-item lines="none">
        <ion-label class="ion-text-wrap">
          <ion-chip
            *ngFor="let tag of getTagsCategory('films')"
            color="secondary"
          >
            <ion-icon
              name="close-circle"
              (click)="removeTag(tag.id)"
            ></ion-icon>
            <ion-label>{{ tag.name }}</ion-label>
          </ion-chip>
        </ion-label>
      </ion-item>
    </ion-item-group>

    <ion-item-group>
      <ion-item class="category-header" lines="full">
        <ion-icon name="book" slot="start"></ion-icon>
        <ion-input
          aria-label="Cómics, mangas o libros"
          #books
          placeholder="{{ 'comics-mangas-libros' | i18n }}"
          clearInput="true"
          autocapitalize="words"
          (ionInput)="searchTag($event.detail.value, 'books')"
          [debounce]="500"
          (keyup.enter)="
                        addTag($event.target.value, 'books'); books.value = ''
                      "
        ></ion-input>
        <ion-icon
          name="add-circle"
          slot="end"
          (click)="addTag(books.value, 'books')"
        ></ion-icon>
      </ion-item>
      <ion-item lines="none">
        <ion-label class="ion-text-wrap">
          <ion-chip
            *ngFor="let tag of getTagsCategory('books')"
            color="secondary"
          >
            <ion-icon
              name="close-circle"
              (click)="removeTag(tag.id)"
            ></ion-icon>
            <ion-label>{{ tag.name }}</ion-label>
          </ion-chip>
        </ion-label>
      </ion-item>
    </ion-item-group>

    <ion-item-group>
      <ion-item class="category-header" lines="full">
        <ion-icon name="dice" slot="start"></ion-icon>
        <ion-input
          aria-label="Juegos de mesa, rol y cartas frikis"
          #role
          placeholder="{{ 'juegos-de-mesa' | i18n }}"
          clearInput="true"
          autocapitalize="words"
          (ionInput)="searchTag($event.detail.value, 'role')"
          [debounce]="500"
          (keyup.enter)="
                        addTag($event.target.value, 'role'); role.value = ''
                      "
        ></ion-input>
        <ion-icon
          name="add-circle"
          slot="end"
          (click)="addTag(role.value, 'role')"
        ></ion-icon>
      </ion-item>
      <ion-item lines="none">
        <ion-label class="ion-text-wrap">
          <ion-chip
            *ngFor="let tag of getTagsCategory('role')"
            color="secondary"
          >
            <ion-icon
              name="close-circle"
              (click)="removeTag(tag.id)"
            ></ion-icon>
            <ion-label>{{ tag.name }}</ion-label>
          </ion-chip>
        </ion-label>
      </ion-item>
    </ion-item-group>

    <ion-item-group>
      <ion-item class="category-header" lines="full">
        <ion-icon name="headset" slot="start"></ion-icon>
        <ion-input
          aria-label="Música, artistas o canciones favoritas"
          #music
          placeholder="{{ 'musica-favorita' | i18n }}"
          clearInput="true"
          autocapitalize="words"
          (ionInput)="searchTag($event.detail.value, 'music')"
          [debounce]="500"
          (keyup.enter)="
                        addTag($event.target.value, 'music'); music.value = ''
                      "
        ></ion-input>
        <ion-icon
          name="add-circle"
          slot="end"
          (click)="addTag(music.value, 'music')"
        ></ion-icon>
      </ion-item>
      <ion-item lines="none">
        <ion-label class="ion-text-wrap">
          <ion-chip
            *ngFor="let tag of getTagsCategory('music')"
            color="secondary"
          >
            <ion-icon
              name="close-circle"
              (click)="removeTag(tag.id)"
            ></ion-icon>
            <ion-label>{{ tag.name }}</ion-label>
          </ion-chip>
        </ion-label>
      </ion-item>
    </ion-item-group>

    <ion-item-group>
      <ion-item class="category-header" lines="full">
        <ion-icon src="/assets/icon/ramen_dining.svg"></ion-icon>
        <ion-input
          aria-label="Comida, bebida o restaurantes favoritos"
          #food
          placeholder="{{ 'food' | i18n }}"
          clearInput="true"
          autocapitalize="words"
          (ionInput)="searchTag($event.detail.value, 'food')"
          [debounce]="500"
          (keyup.enter)="
                        addTag($event.target.value, 'food'); food.value = ''
                      "
        ></ion-input>
        <ion-icon
          name="add-circle"
          slot="end"
          (click)="addTag(food.value, 'food')"
        ></ion-icon>
      </ion-item>
      <ion-item lines="none">
        <ion-label class="ion-text-wrap">
          <ion-chip
            *ngFor="let tag of getTagsCategory('food')"
            color="secondary"
          >
            <ion-icon
              name="close-circle"
              (click)="removeTag(tag.id)"
            ></ion-icon>
            <ion-label>{{ tag.name }}</ion-label>
          </ion-chip>
        </ion-label>
      </ion-item>
    </ion-item-group>
  </ion-list>
</ion-content>
<ion-footer *ngIf="showFooter">
  <ion-button
    (click)="submitProfile()"
    class="ion-padding"
    color="primary"
    [disabled]="!profileForm.valid"
    expand="block"
    shape="round"
    >{{ "guardar-salir" | i18n }}
  </ion-button>
</ion-footer>

<!-- modals -->

<ion-modal
  [initialBreakpoint]="0.4"
  [breakpoints]="[0, 0.4, 0.6]"
  cssClass="sheet-modal"
  [isOpen]="isPictureSheetOpen"
  (ionModalDidDismiss)="closePictureSheet()"
>
  <ng-template>
    <ion-content class="ion-padding">
      <p>{{"consejo-recuerda-que-subir-fotos" | i18n}}</p>
      <ion-list>
        <ion-item
          button
          detail="false"
          (click)="selectPictureFromCamera()"
          lines="none"
        >
          <ion-icon slot="start" name="camera" color="light"></ion-icon>
          <ion-label>{{ "desde-cmara" | i18n }}</ion-label>
        </ion-item>
        <ion-item
          lines="none"
          button
          detail="false"
          (click)="selectPictureFromGallery()"
        >
          <ion-icon slot="start" name="images" color="light"></ion-icon>
          <ion-label>{{ "desde-galera" | i18n }}</ion-label>
        </ion-item>
      </ion-list>
    </ion-content>
  </ng-template>
</ion-modal>

<ion-modal
  [breakpoints]="[0, 0.6]"
  [initialBreakpoint]="0.6"
  cssClass="sheet-modal"
  id="suggested-tags-sheet"
  [isOpen]="openSuggestions"
>
  <ng-template>
    <ion-content class="ion-padding">
      <p>{{ "elige-una-sugerencias-sigue-escribiendo" | i18n }}</p>
      <ion-list>
        <ion-item
          button
          detail="false"
          (click)="addTag(tag.name, tag.category);"
          lines="none"
          *ngFor="let tag of suggestedTags"
        >
          <ion-thumbnail slot="start" *ngIf="tag.image">
            <img [src]="tag.image" />
          </ion-thumbnail>
          <ion-label class="ion-text-wrap">{{tag.name}}</ion-label>
          <ion-badge slot="end">{{tag.total}}</ion-badge>
        </ion-item>
      </ion-list>
    </ion-content>
  </ng-template>
</ion-modal>
